{% extends 'base/base.html' %}

{% block title %}Orders Management - Canteen Admin{% endblock %}

{% block user_name %}{{ user.first_name }} {{ user.last_name }}{% endblock %}
{% load static %}

{% block sidebar %}
<a class="nav-link" href="{% url 'canteen_admin:dashboard' %}">
    <i class="bi bi-speedometer2 me-2"></i>Dashboard
</a>
<a class="nav-link" href="{% url 'canteen_admin:menu_management' %}">
    <i class="bi bi-menu-button-wide me-2"></i>Menu Management
</a>
<a class="nav-link active" href="{% url 'canteen_admin:orders_management' %}">
    <i class="bi bi-bag me-2"></i>Orders Management
    {% if pending_orders > 0 %}
    <span class="badge bg-warning rounded-pill">{{ pending_orders }}</span>
    {% endif %}
</a>
<a class="nav-link" href="{% url 'canteen_admin:inventory' %}">
    <i class="bi bi-boxes me-2"></i>Inventory
    {% if low_stock_items > 0 %}
    <span class="badge bg-danger rounded-pill">{{ low_stock_items }}</span>
    {% endif %}
</a>
<a class="nav-link" href="{% url 'canteen_admin:notifications_page' %}">
    <i class="bi bi-bell me-2"></i>Notifications
</a>
<a class="nav-link" href="{% url 'canteen_admin:reports' %}">
    <i class="bi bi-graph-up me-2"></i>Reports
</a>
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'canteen_admin:dashboard' %}">Canteen Admin</a></li>
<li class="breadcrumb-item active">Orders Management</li>
{% endblock %}

{% block page_title %}Orders Management{% endblock %}

{% block page_actions %}
<button class="btn btn-success me-2" onclick="processAllPending()">
    <i class="bi bi-check-all me-2"></i>Process All Pending
</button>
<button class="btn btn-outline-primary me-2" onclick="exportOrders()">
    <i class="bi bi-download me-2"></i>Export Orders
</button>
<button class="btn btn-outline-secondary" onclick="refreshOrders()">
    <i class="bi bi-arrow-clockwise me-2"></i>Refresh
</button>
{% endblock %}

{% block content %}
<!-- Order Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stats-card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="card-title mb-0">{{ pending_count }}</h4>
                        <p class="card-text">Pending Orders</p>
                    </div>
                    <i class="bi bi-clock fs-1 opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stats-card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="card-title mb-0">{{ preparing_count }}</h4>
                        <p class="card-text">Being Prepared</p>
                    </div>
                    <i class="bi bi-gear fs-1 opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stats-card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="card-title mb-0">{{ ready_count }}</h4>
                        <p class="card-text">Ready for Pickup</p>
                    </div>
                    <i class="bi bi-check-circle fs-1 opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stats-card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="card-title mb-0">{{ completed_today }}</h4>
                        <p class="card-text">Completed Today</p>
                    </div>
                    <i class="bi bi-check2-all fs-1 opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Filters -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-funnel me-2"></i>Order Filters
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-2">
                        <select class="form-select" id="statusFilter">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="preparing">Preparing</option>
                            <option value="ready">Ready</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="paymentFilter">
                            <option value="">All Payments</option>
                            <option value="paid">Paid</option>
                            <option value="pending">Payment Pending</option>
                            <option value="failed">Payment Failed</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="timeFilter">
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control" id="customerSearch" 
                               placeholder="Search by customer name...">
                    </div>
                    <div class="col-md-2">
                        <input type="text" class="form-control" id="orderIdSearch" 
                               placeholder="Order ID...">
                    </div>
                    <div class="col-md-1">
                        <button class="btn btn-outline-secondary" onclick="clearFilters()">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Priority Queue - Pending Orders -->
{% if pending_orders_list %}
<div class="card mb-4">
  <div class="card-header">
    <h5>Priority Queue - Pending Orders <span class="badge bg-danger">{{ pending_orders_list|length }}</span></h5>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table">
        {% for order in pending_orders_list %}
        <tr>
          <td>
            <strong>#{{ order.order_number }}</strong><br>
            <span class="badge bg-warning">{{ order.get_status_display }}</span>
          </td>
          <td>
            {{ order.employee.first_name }} {{ order.employee.last_name }}<br>
            {{ order.created_at|date:"H:i" }} - {{ order.items.count }} items
          </td>
          <td>
            {{ order.total_amount }} XAF<br>
            {% if order.payment_status == 'paid' %}
              <span class="badge bg-success">Paid</span>
            {% else %}
              <span class="badge bg-secondary">Payment Pending</span>
            {% endif %}
          </td>
          <td>
            <button class="btn btn-sm btn-success confirm-order-btn" data-order-id="{{ order.id }}">Confirm</button>
            <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#orderDetailsModal" data-order-id="{{ order.id }}">Details</button>
            <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#cancelOrderModal" data-order-id="{{ order.id }}">Cancel</button>
          </td>
        </tr>
        {% endfor %}
      </table>
    </div>
  </div>
</div>
{% endif %}

<!-- Main Orders Table -->
<div class="card">
    <div class="card-header">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul me-2"></i>All Orders
                </h5>
            </div>
            <div class="col-md-6">
                <div class="row g-2">
                    <div class="col-md-8">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" class="form-control" id="globalSearch" 
                                   placeholder="Search orders, customers, items...">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select form-select-sm" id="sortOrders">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                            <option value="amount_high">Amount (High to Low)</option>
                            <option value="amount_low">Amount (Low to High)</option>
                            <option value="status">By Status</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- All Orders -->
<div class="card mb-4">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Order #</th>
            <th>Customer</th>
            <th>Items</th>
            <th>Amount</th>
            <th>Payment</th>
            <th>Status</th>
            <th>Time</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for order in orders %}
          <tr>
            <td>
              #{{ order.order_number }}
              {% if order.special_instructions %}
              <i class="fas fa-sticky-note" title="Has notes"></i>
              {% endif %}
            </td>
            <td>
              <div class="d-flex align-items-center">
                <div class="avatar avatar-sm bg-primary rounded-circle me-2">
                  {{ order.employee.first_name.0 }}{{ order.employee.last_name.0 }}
                </div>
                <div>
                  {{ order.employee.first_name }} {{ order.employee.last_name }}<br>
                  {{ order.employee.email }}
                </div>
              </div>
            </td>
            <td>
              {% for item in order.items.all|slice:":2" %}
              <div>
                {% if item.menu_item.image %}
                <img src="{{ item.menu_item.image.url }}" alt="" width="20" class="me-1">
                {% endif %}
                {{ item.quantity }}x {{ item.menu_item.name }}
              </div>
              {% endfor %}
              {% if order.items.count > 2 %}
              +{{ order.items.count|add:"-2" }} more items
              {% endif %}
            </td>
            <td>
              {{ order.total_amount|floatformat:0 }} XAF
              {% if order.discount_amount > 0 %}
              -{{ order.discount_amount }} XAF discount
              {% endif %}
            </td>
            <td>
              {% if order.payment_status == 'paid' %}
              <span class="badge bg-success">Paid {{ order.payment_method }}</span>
              {% elif order.payment_status == 'pending' %}
              <span class="badge bg-warning">Pending</span>
              {% elif order.payment_status == 'failed' %}
              <span class="badge bg-danger">Failed</span>
              {% endif %}
            </td>
            <td>
              {% if order.status == 'pending' %}
              <span class="badge bg-warning">Pending</span>
              {% elif order.status == 'confirmed' %}
              <span class="badge bg-info">Confirmed</span>
              {% elif order.status == 'preparing' %}
              <span class="badge bg-primary">Preparing</span>
              {% elif order.status == 'ready' %}
              <span class="badge bg-success">Ready</span>
              {% elif order.status == 'completed' %}
              <span class="badge bg-success">Completed</span>
              {% elif order.status == 'cancelled' %}
              <span class="badge bg-danger">Cancelled</span>
              {% endif %}
              {% if order.estimated_ready_time %}
              <br>ETA: {{ order.estimated_ready_time|date:"H:i" }}
              {% endif %}
            </td>
            <td>
              {{ order.created_at|date:"H:i" }}<br>
              {{ order.created_at|date:"M d" }}
            </td>
            <td>
              {% if order.status == 'pending' %}
              <button class="btn btn-sm btn-success confirm-order-btn" data-order-id="{{ order.id }}">Confirm</button>
              {% elif order.status == 'confirmed' %}
              <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#updateStatusModal" data-order-id="{{ order.id }}">Update</button>
              {% elif order.status == 'preparing' %}
              <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#updateStatusModal" data-order-id="{{ order.id }}">Update</button>
              {% elif order.status == 'ready' %}
              <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#updateStatusModal" data-order-id="{{ order.id }}">Update</button>
              {% endif %}
              <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#orderDetailsModal" data-order-id="{{ order.id }}">Details</button>
              {% if order.status in 'pending,confirmed' %}
              <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#cancelOrderModal" data-order-id="{{ order.id }}">Cancel</button>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" class="text-center">No orders found</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
        
        <!-- Pagination -->
        {% if orders.has_other_pages %}
        <div class="card-footer">
            <nav aria-label="Orders pagination">
                <ul class="pagination justify-content-center mb-0">
                    {% if orders.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ orders.previous_page_number }}">Previous</a>
                    </li>
                    {% endif %}
                    
                    {% for num in orders.paginator.page_range %}
                    {% if orders.number == num %}
                    <li class="page-item active">
                        <span class="page-link">{{ num }}</span>
                    </li>
                    {% elif num > orders.number|add:'-3' and num < orders.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                    </li>
                    {% endif %}
                    {% endfor %}
                    
                    {% if orders.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ orders.next_page_number }}">Next</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>

<!-- Order Details Modal -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="orderDetailsContent">
                <!-- Order details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="printOrder()">
                    <i class="bi bi-printer me-2"></i>Print Order
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Update Order Status Modal -->
<div class="modal fade" id="updateStatusModal" tabindex="-1" aria-labelledby="updateStatusModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="updateStatusModalLabel">Update Order Status</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="updateStatusForm" data-order-id="">
          {% csrf_token %}
          <div class="mb-3">
            <label for="statusSelect" class="form-label">New Status</label>
            <select class="form-select" id="statusSelect" name="status" required>
              <option value="">Select Status</option>
              <option value="confirmed">Confirmed</option>
              <option value="preparing">Preparing</option>
              <option value="ready">Ready for Pickup</option>
              <option value="completed">Completed</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="estimatedReadyTime" class="form-label">Estimated Ready Time</label>
            <input type="datetime-local" class="form-control" id="estimatedReadyTime" name="estimated_ready_time">
          </div>
          <div class="mb-3">
            <label for="statusNotes" class="form-label">Notes (Optional)</label>
            <textarea class="form-control" id="statusNotes" name="notes" rows="3"></textarea>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="notifyCustomer" name="notify_customer" checked>
            <label class="form-check-label" for="notifyCustomer">Notify customer about status change</label>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Update Status</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Cancel Order Modal -->
<div class="modal fade" id="cancelOrderModal" tabindex="-1" aria-labelledby="cancelOrderModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cancelOrderModalLabel">Cancel Order</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="cancelOrderForm" data-order-id="">
          {% csrf_token %}
          <div class="mb-3">
            <p>Are you sure you want to cancel this order? This action cannot be undone.</p>
          </div>
          <div class="mb-3">
            <label for="cancellationReason" class="form-label">Cancellation Reason</label>
            <select class="form-select" id="cancellationReason" name="reason" required>
              <option value="">Select Reason</option>
              <option value="customer_request">Customer Request</option>
              <option value="payment_failed">Payment Failed</option>
              <option value="item_not_available">Item Not Available</option>
              <option value="kitchen_issue">Kitchen Issue</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="cancellationNotes" class="form-label">Additional Notes</label>
            <textarea class="form-control" id="cancellationNotes" name="notes" rows="3"></textarea>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="processRefund" name="process_refund">
            <label class="form-check-label" for="processRefund">Process refund (if payment was completed)</label>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-danger">Confirm Cancellation</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.stats-card {
    transition: transform 0.2s;
    cursor: pointer;
}

.stats-card:hover {
    transform: translateY(-2px);
}

.order-row {
    transition: background-color 0.2s;
}

.order-row:hover {
    background-color: #f8f9fa;
}

.avatar-sm {
    width: 32px;
    height: 32px;
    font-size: 0.75rem;
}

.order-items img {
    object-fit: cover;
}

.badge {
    font-size: 0.7em;
}

.table th {
    border-top: none;
    font-weight: 600;
    background-color: #f8f9fa;
}

#orderDetailsContent {
    max-height: 70vh;
    overflow-y: auto;
}

.border-start {
    border-left-width: 3px !important;
}

.btn-group-sm .btn {
    font-size: 0.75rem;
}

.form-select-sm, .form-control-sm {
    font-size: 0.875rem;
}

@media (max-width: 768px) {
    .btn-group {
        flex-direction: column;
    }
    
    .btn-group .btn {
        border-radius: 0.375rem !important;
        margin-bottom: 2px;
    }
}

.loading {
    opacity: 0.6;
    pointer-events: none;
}

.pulse {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% {
        opacity: 1;
    }
    50% {
        opacity: 0.5;
    }
    100% {
        opacity: 1;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize filters
    initializeFilters();
    
    // Auto-refresh for pending orders
    if (document.querySelectorAll('.order-row[data-status="pending"]').length > 0) {
        setInterval(refreshPendingOrders, 30000); // Refresh every 30 seconds
    }
    
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Add click handlers for stats cards
    document.querySelectorAll('.stats-card').forEach(card => {
        card.addEventListener('click', function() {
            const status = this.classList.contains('bg-warning') ? 'pending' :
                          this.classList.contains('bg-primary') ? 'preparing' :
                          this.classList.contains('bg-info') ? 'ready' : 'completed';
            
            document.getElementById('statusFilter').value = status;
            filterOrders();
        });
    });
    
    // Initialize form handlers
    initializeFormHandlers();
});

function initializeFilters() {
    // Status filter
    document.getElementById('statusFilter').addEventListener('change', function() {
        filterOrders();
    });
    
    // Payment filter
    document.getElementById('paymentFilter').addEventListener('change', function() {
        filterOrders();
    });
    
    // Time filter
    document.getElementById('timeFilter').addEventListener('change', function() {
        filterOrders();
    });
    
    // Search filters
    document.getElementById('customerSearch').addEventListener('input', function() {
        filterOrders();
    });
    
    document.getElementById('orderIdSearch').addEventListener('input', function() {
        filterOrders();
    });
    
    document.getElementById('globalSearch').addEventListener('input', function() {
        globalSearchOrders(this.value);
    });
    
    // Sort orders
    document.getElementById('sortOrders').addEventListener('change', function() {
        sortOrders(this.value);
    });
}

function initializeFormHandlers() {
    // Update Status Form
    document.getElementById('updateStatusForm').addEventListener('submit', function(e) {
        e.preventDefault();
        handleStatusUpdate();
    });
    
    // Cancel Order Form
    document.getElementById('cancelOrderForm').addEventListener('submit', function(e) {
        e.preventDefault();
        handleOrderCancellation();
    });
    
    // Show/hide ready time section
    document.getElementById('newStatus').addEventListener('change', function() {
        const readyTimeSection = document.getElementById('readyTimeSection');
        if (this.value === 'ready') {
            readyTimeSection.style.display = 'block';
        } else {
            readyTimeSection.style.display = 'none';
        }
    });
}

function filterOrders() {
    const statusFilter = document.getElementById('statusFilter').value;
    const paymentFilter = document.getElementById('paymentFilter').value;
    const timeFilter = document.getElementById('timeFilter').value;
    const customerSearch = document.getElementById('customerSearch').value.toLowerCase();
    const orderIdSearch = document.getElementById('orderIdSearch').value.toLowerCase();
    
    const rows = document.querySelectorAll('.order-row');
    
    rows.forEach(row => {
        let show = true;
        const text = row.textContent.toLowerCase();
        
        // Status filter
        if (statusFilter && !text.includes(statusFilter)) {
            show = false;
        }
        
        // Payment filter
        if (paymentFilter && !text.includes(paymentFilter)) {
            show = false;
        }
        
        // Customer search
        if (customerSearch && !text.includes(customerSearch)) {
            show = false;
        }
        
        // Order ID search
        if (orderIdSearch && !text.includes(orderIdSearch)) {
            show = false;
        }
        
        row.style.display = show ? '' : 'none';
    });
}

function globalSearchOrders(searchTerm) {
    const rows = document.querySelectorAll('.order-row');
    const lowerSearchTerm = searchTerm.toLowerCase();
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const show = text.includes(lowerSearchTerm);
        row.style.display = show ? '' : 'none';
    });
}

function sortOrders(sortBy) {
    const tbody = document.querySelector('#ordersTable tbody');
    const rows = Array.from(tbody.querySelectorAll('.order-row'));
    
    rows.sort((a, b) => {
        switch (sortBy) {
            case 'newest':
                return new Date(b.querySelector('td:nth-child(7)').textContent) - 
                       new Date(a.querySelector('td:nth-child(7)').textContent);
            case 'oldest':
                return new Date(a.querySelector('td:nth-child(7)').textContent) - 
                       new Date(b.querySelector('td:nth-child(7)').textContent);
            case 'amount_high':
                return parseFloat(b.querySelector('td:nth-child(4) .fw-bold').textContent.replace(/[^\d.]/g, '')) - 
                       parseFloat(a.querySelector('td:nth-child(4) .fw-bold').textContent.replace(/[^\d.]/g, ''));
            case 'amount_low':
                return parseFloat(a.querySelector('td:nth-child(4) .fw-bold').textContent.replace(/[^\d.]/g, '')) - 
                       parseFloat(b.querySelector('td:nth-child(4) .fw-bold').textContent.replace(/[^\d.]/g, ''));
            case 'status':
                return a.querySelector('td:nth-child(6)').textContent.localeCompare(
                       b.querySelector('td:nth-child(6)').textContent);
            default:
                return 0;
        }
    });
    
    rows.forEach(row => tbody.appendChild(row));
}

function clearFilters() {
    document.getElementById('statusFilter').value = '';
    document.getElementById('paymentFilter').value = '';
    document.getElementById('timeFilter').value = 'today';
    document.getElementById('customerSearch').value = '';
    document.getElementById('orderIdSearch').value = '';
    document.getElementById('globalSearch').value = '';
    
    filterOrders();
}

// Order Management Functions
function confirmOrder(orderId) {
    updateOrderStatus(orderId, 'confirmed');
}

function startPreparation(orderId) {
    updateOrderStatus(orderId, 'preparing');
}

function markReady(orderId) {
    document.getElementById('statusOrderId').value = orderId;
    document.getElementById('newStatus').value = 'ready';
    document.getElementById('readyTimeSection').style.display = 'block';
    
    // Set default ready time to 15 minutes from now
    const now = new Date();
    now.setMinutes(now.getMinutes() + 15);
    document.getElementById('estimatedTime').value = now.toTimeString().slice(0, 5);
    
    new bootstrap.Modal(document.getElementById('updateStatusModal')).show();
}

function completeOrder(orderId) {
    if (confirm('Mark this order as completed?')) {
        updateOrderStatus(orderId, 'completed');
    }
}

function cancelOrder(orderId) {
    document.getElementById('cancelOrderId').value = orderId;
    new bootstrap.Modal(document.getElementById('cancelOrderModal')).show();
}

function updateOrderStatus(orderId, status, additionalData = {}) {
    showLoading(true);
    
    const formData = new FormData();
    formData.append('order_id', orderId);
    formData.append('status', status);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    // Add additional data
    Object.keys(additionalData).forEach(key => {
        formData.append(key, additionalData[key]);
    });
    
    fetch('/canteen-admin/orders/update-status/', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        showLoading(false);
        if (data.success) {
            showToast('Order status updated successfully', 'success');
            // Update the row in the table
            updateOrderRowInTable(orderId, data.order);
        } else {
            showToast(data.message || 'Error updating order status', 'error');
        }
    })
    .catch(error => {
        showLoading(false);
        showToast('Error updating order status', 'error');
        console.error('Error:', error);
    });
}

function handleStatusUpdate() {
    const form = document.getElementById('updateStatusForm');
    const formData = new FormData(form);
    
    showLoading(true);
    
    fetch('/canteen-admin/orders/update-status/', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        showLoading(false);
        if (data.success) {
            showToast('Order status updated successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('updateStatusModal')).hide();
            updateOrderRowInTable(formData.get('order_id'), data.order);
        } else {
            showToast(data.message || 'Error updating order status', 'error');
        }
    })
    .catch(error => {
        showLoading(false);
        showToast('Error updating order status', 'error');
        console.error('Error:', error);
    });
}

function handleOrderCancellation() {
    const form = document.getElementById('cancelOrderForm');
    const formData = new FormData(form);
    
    showLoading(true);
    
    fetch('/canteen-admin/orders/cancel/', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        showLoading(false);
        if (data.success) {
            showToast('Order cancelled successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('cancelOrderModal')).hide();
            updateOrderRowInTable(formData.get('order_id'), data.order);
        } else {
            showToast(data.message || 'Error cancelling order', 'error');
        }
    })
    .catch(error => {
        showLoading(false);
        showToast('Error cancelling order', 'error');
        console.error('Error:', error);
    });
}

function viewOrderDetails(orderId) {
    showLoading(true);
    
    fetch(`/canteen-admin/orders/${orderId}/details/`)
    .then(response => response.json())
    .then(data => {
        showLoading(false);
        if (data.success) {
            document.getElementById('orderDetailsContent').innerHTML = data.html;
            new bootstrap.Modal(document.getElementById('orderDetailsModal')).show();
        } else {
            showToast('Error loading order details', 'error');
        }
    })
    .catch(error => {
        showLoading(false);
        showToast('Error loading order details', 'error');
        console.error('Error:', error);
    });
}

function processAllPending() {
    const pendingOrders = document.querySelectorAll('.order-row[data-status="pending"]');
    
    if (pendingOrders.length === 0) {
        showToast('No pending orders to process', 'info');
        return;
    }
    
    if (!confirm(`Process ${pendingOrders.length} pending orders?`)) {
        return;
    }
    
    showLoading(true);
    
    const orderIds = Array.from(pendingOrders).map(row => row.dataset.orderId);
    
    fetch('/canteen-admin/orders/process-all-pending/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ order_ids: orderIds })
    })
    .then(response => response.json())
    .then(data => {
        showLoading(false);
        if (data.success) {
            showToast(`${data.processed_count} orders processed successfully`, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast(data.message || 'Error processing orders', 'error');
        }
    })
    .catch(error => {
        showLoading(false);
        showToast('Error processing orders', 'error');
        console.error('Error:', error);
    });
}

function exportOrders() {
    const filters = {
        status: document.getElementById('statusFilter').value,
        payment: document.getElementById('paymentFilter').value,
        time: document.getElementById('timeFilter').value
    };
    
    const queryString = new URLSearchParams(filters).toString();
    window.open(`/canteen-admin/orders/export/?${queryString}`, '_blank');
}

function refreshOrders() {
    location.reload();
}

function refreshPendingOrders() {
    // Refresh only pending orders section
    fetch('/canteen-admin/orders/pending-orders/')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update pending orders count in sidebar
            const pendingBadge = document.querySelector('.nav-link[href*="orders_management"] .badge');
            if (pendingBadge) {
                pendingBadge.textContent = data.pending_count;
                pendingBadge.style.display = data.pending_count > 0 ? '' : 'none';
            }
            
            // Update stats cards
            document.querySelector('.stats-card.bg-warning h4').textContent = data.pending_count;
        }
    })
    .catch(error => console.error('Error refreshing pending orders:', error));
}

function updateOrderRowInTable(orderId, orderData) {
    const row = document.querySelector(`[data-order-id="${orderId}"]`);
    if (!row) return;
    
    // Update status badge
    const statusCell = row.querySelector('td:nth-child(6)');
    const statusBadge = statusCell.querySelector('.badge');
    
    const statusClasses = {
        'pending': 'bg-warning',
        'confirmed': 'bg-info',
        'preparing': 'bg-primary',
        'ready': 'bg-success',
        'completed': 'bg-dark',
        'cancelled': 'bg-danger'
    };
    
    // Remove all status classes and add new one
    Object.values(statusClasses).forEach(cls => statusBadge.classList.remove(cls));
    statusBadge.classList.add(statusClasses[orderData.status]);
    statusBadge.textContent = orderData.status_display;
    
    // Update ETA if available
    const etaElement = statusCell.querySelector('small');
    if (orderData.estimated_ready_time && orderData.status === 'ready') {
        if (etaElement) {
            etaElement.textContent = `ETA: ${orderData.estimated_ready_time}`;
        } else {
            statusCell.insertAdjacentHTML('beforeend', 
                `<small class="d-block text-muted">ETA: ${orderData.estimated_ready_time}</small>`);
        }
    } else if (etaElement) {
        etaElement.remove();
    }
    
    // Update action buttons
    updateActionButtons(row, orderData.status);
    
    // Update row data attribute
    row.dataset.status = orderData.status;
}

function updateActionButtons(row, status) {
    const actionsCell = row.querySelector('td:last-child .btn-group');
    const orderId = row.dataset.orderId;
    
    let buttonsHtml = '';
    
    switch (status) {
        case 'pending':
            buttonsHtml = `
                <button class="btn btn-outline-success" onclick="confirmOrder('${orderId}')" title="Confirm Order">
                    <i class="bi bi-check"></i>
                </button>`;
            break;
        case 'confirmed':
            buttonsHtml = `
                <button class="btn btn-outline-primary" onclick="startPreparation('${orderId}')" title="Start Preparation">
                    <i class="bi bi-play"></i>
                </button>`;
            break;
        case 'preparing':
            buttonsHtml = `
                <button class="btn btn-outline-info" onclick="markReady('${orderId}')" title="Mark Ready">
                    <i class="bi bi-check-circle"></i>
                </button>`;
            break;
        case 'ready':
            buttonsHtml = `
                <button class="btn btn-outline-dark" onclick="completeOrder('${orderId}')" title="Complete Order">
                    <i class="bi bi-check2-all"></i>
                </button>`;
            break;
    }
    
    // Always add view details button
    buttonsHtml += `
        <button class="btn btn-outline-secondary" onclick="viewOrderDetails('${orderId}')" title="View Details">
            <i class="bi bi-eye"></i>
        </button>`;
    
    // Add cancel button for pending/confirmed orders
    if (status === 'pending' || status === 'confirmed') {
        buttonsHtml += `
            <button class="btn btn-outline-danger" onclick="cancelOrder('${orderId}')" title="Cancel Order">
                <i class="bi bi-x"></i>
            </button>`;
    }
    
    actionsCell.innerHTML = buttonsHtml;
}

// Utility Functions (showLoading, showToast remain unchanged from previous response)
function showLoading(show) {
  const body = document.body;
  if (show) {
    body.classList.add('loading');
  } else {
    body.classList.remove('loading');
  }
}

function showToast(message, type = 'info') {
  let toastContainer = document.querySelector('.toast-container');
  if (!toastContainer) {
    toastContainer = document.createElement('div');
    toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
    toastContainer.style.zIndex = '9999';
    document.body.appendChild(toastContainer);
  }

  const toastId = 'toast-' + Date.now();
  const toastHtml = `
    <div id="${toastId}" class="toast bg-${type} text-white" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto">Notification</strong>
        <small class="text-muted">Just now</small>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body">
        ${message}
      </div>
    </div>
  `;
  toastContainer.insertAdjacentHTML('beforeend', toastHtml);

  const toastElement = document.getElementById(toastId);
  if (!toastElement) {
    console.error('Failed to create toast element');
    return;
  }

  try {
    const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
    toast.show();
    toastElement.addEventListener('hidden.bs.toast', function() {
      this.remove();
    });
  } catch (error) {
    console.error('Bootstrap Toast initialization failed:', error);
    alert(message);
  }
}

// Add loading overlay styles
document.head.insertAdjacentHTML('beforeend', `
  <style>
    .loading {
      position: relative;
    }
    .loading::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 9998;
    }
    .loading::after {
      content: '';
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 40px;
      height: 40px;
      border: 4px solid #fff;
      border-top-color: #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      z-index: 9999;
    }
    @keyframes spin {
      to {
        transform: translate(-50%, -50%) rotate(360deg);
      }
    }
  </style>
`);

// AJAX handler for order actions
function handleOrderAction(orderId, action, formData, modalId) {
  showLoading(true);
  fetch(`/orders/admin/${action}/${orderId}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(formData),
  })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! Status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      showLoading(false);
      if (data.success) {
        showToast(data.message, 'success');
        if (modalId) {
          bootstrap.Modal.getInstance(document.getElementById(modalId)).hide();
        }
        setTimeout(() => location.reload(), 1000); // Refresh to reflect changes
      } else {
        showToast(data.message || 'An error occurred', 'danger');
      }
    })
    .catch(error => {
      showLoading(false);
      showToast('Network error: ' + error.message, 'danger');
    });
}

// Attach event listeners
document.addEventListener('DOMContentLoaded', function() {
  // Confirm order buttons
  document.querySelectorAll('.confirm-order-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const orderId = this.dataset.orderId;
      handleOrderAction(orderId, 'confirm', {}, null);
    });
  });

  // Update modal order ID dynamically
  document.querySelectorAll('[data-bs-target="#updateStatusModal"]').forEach(btn => {
    btn.addEventListener('click', function() {
      document.getElementById('updateStatusForm').dataset.orderId = this.dataset.orderId;
    });
  });

  // Update status form submission
  document.getElementById('updateStatusForm')?.addEventListener('submit', function(e) {
    e.preventDefault();
    const orderId = this.dataset.orderId;
    const formData = {
      status: this.querySelector('#statusSelect').value,
      estimated_ready_time: this.querySelector('#estimatedReadyTime').value,
      notes: this.querySelector('#statusNotes').value,
      notify_customer: this.querySelector('#notifyCustomer').checked,
    };
    handleOrderAction(orderId, 'update-status', formData, 'updateStatusModal');
  });

  // Cancel modal order ID dynamically
  document.querySelectorAll('[data-bs-target="#cancelOrderModal"]').forEach(btn => {
    btn.addEventListener('click', function() {
      document.getElementById('cancelOrderForm').dataset.orderId = this.dataset.orderId;
    });
  });

  // Cancel order form submission
  document.getElementById('cancelOrderForm')?.addEventListener('submit', function(e) {
    e.preventDefault();
    const orderId = this.dataset.orderId;
    const formData = {
      reason: this.querySelector('#cancellationReason').value,
      notes: this.querySelector('#cancellationNotes').value,
      process_refund: this.querySelector('#processRefund').checked,
    };
    handleOrderAction(orderId, 'cancel', formData, 'cancelOrderModal');
  });
});

// Complete Enhanced JavaScript for Orders Management Template
// This handles order confirmation, cancellation, details, and filtering with email notifications

document.addEventListener('DOMContentLoaded', function() {
    // Initialize all functionality
    initializeOrderActions();
    initializeFilters();
    initializeModals();
    initializeToast();
    
    // Auto-refresh for pending orders every 30 seconds
    setInterval(refreshOrderCounts, 30000);
    
    // Initialize export and print functions
    initializeExportPrint();
});

// Global variables for managing state
let loadingOverlay = null;
let toastContainer = null;

function initializeToast() {
    // Create toast container if it doesn't exist
    if (!document.getElementById('toast-container')) {
        const container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'position-fixed top-0 end-0 p-3';
        container.style.zIndex = '9999';
        document.body.appendChild(container);
    }
    toastContainer = document.getElementById('toast-container');
}

function showToast(message, type = 'info') {
    if (!toastContainer) initializeToast();
    
    const toastId = 'toast-' + Date.now();
    const bgClass = {
        'success': 'bg-success',
        'error': 'bg-danger',
        'warning': 'bg-warning',
        'info': 'bg-info'
    }[type] || 'bg-info';
    
    const toastHTML = `
        <div class="toast ${bgClass} text-white" id="${toastId}" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header ${bgClass} text-white border-0">
                <strong class="me-auto">Notification</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHTML);
    
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
    toast.show();
    
    // Auto-remove toast after it's hidden
    toastElement.addEventListener('hidden.bs.toast', function() {
        toastElement.remove();
    });
}

function showLoading(show = true) {
    if (show) {
        if (!loadingOverlay) {
            loadingOverlay = document.createElement('div');
            loadingOverlay.id = 'loading-overlay';
            loadingOverlay.innerHTML = `
                <div class="d-flex justify-content-center align-items-center h-100">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;
            loadingOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
                z-index: 9998;
                display: none;
            `;
            document.body.appendChild(loadingOverlay);
        }
        loadingOverlay.style.display = 'block';
    } else {
        if (loadingOverlay) {
            loadingOverlay.style.display = 'none';
        }
    }
}

function initializeOrderActions() {
    // Confirm Order Action with Email
    document.querySelectorAll('.confirm-order-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const orderId = this.dataset.orderId;
            const orderNumber = this.closest('tr').querySelector('td:first-child strong').textContent;
            
            if (confirm(`Confirm order ${orderNumber}? This will send a payment link to the customer's email.`)) {
                confirmOrderWithEmail(orderId);
            }
        });
    });

    // Cancel Order Action with Email
    document.querySelectorAll('[data-bs-target="#cancelOrderModal"]').forEach(btn => {
        btn.addEventListener('click', function() {
            const orderId = this.dataset.orderId;
            const orderRow = this.closest('tr');
            const orderNumber = orderRow.querySelector('td:first-child strong').textContent;
            const customerEmail = extractEmailFromRow(orderRow);
            
            document.getElementById('cancelOrderForm').dataset.orderId = orderId;
            document.querySelector('#cancelOrderModal .modal-title').textContent = `Cancel Order ${orderNumber}`;
            document.getElementById('customerEmailDisplay').textContent = customerEmail || 'Email not available';
        });
    });

    // Update Status Action
    document.querySelectorAll('[data-bs-target="#updateStatusModal"]').forEach(btn => {
        btn.addEventListener('click', function() {
            const orderId = this.dataset.orderId;
            const orderRow = this.closest('tr');
            const orderNumber = orderRow.querySelector('td:first-child strong').textContent;
            
            document.getElementById('updateStatusForm').dataset.orderId = orderId;
            document.querySelector('#updateStatusModal .modal-title').textContent = `Update Status - ${orderNumber}`;
            
            // Pre-populate current status
            const currentStatusElement = orderRow.querySelector('td:nth-child(6) .badge');
            if (currentStatusElement) {
                const currentStatus = currentStatusElement.textContent.toLowerCase().trim();
                const statusSelect = document.getElementById('statusSelect');
                if (statusSelect) {
                    statusSelect.value = mapDisplayStatusToValue(currentStatus);
                }
            }
        });
    });

    // Order Details Action
    document.querySelectorAll('[data-bs-target="#orderDetailsModal"]').forEach(btn => {
        btn.addEventListener('click', function() {
            const orderId = this.dataset.orderId;
            loadOrderDetails(orderId);
        });
    });
}

function confirmOrderWithEmail(orderId) {
    showLoading(true);
    
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', getCsrfToken());
    formData.append('action', 'confirm');
    formData.append('send_email', 'true');
    
    fetch(`/orders/admin/confirm/${orderId}/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        showLoading(false);
        if (data.success) {
            showToast(data.message || 'Order confirmed and payment link sent successfully!', 'success');
            
            // Update the order row in the table
            updateOrderRowStatus(orderId, 'confirmed');
            
            // Refresh counts
            refreshOrderCounts();
            
            // Log activity
            console.log(`Order ${orderId} confirmed with email notification sent`);
        } else {
            showToast(data.message || 'Error confirming order', 'error');
        }
    })
    .catch(error => {
        showLoading(false);
        console.error('Error confirming order:', error);
        showToast('Network error occurred while confirming order', 'error');
    });
}

function handleOrderCancellation() {
    const form = document.getElementById('cancelOrderForm');
    const orderId = form.dataset.orderId;
    const reason = form.querySelector('#cancellationReason').value;
    const notes = form.querySelector('#cancellationNotes').value;
    const processRefund = form.querySelector('#processRefund')?.checked || false;
    const sendEmail = form.querySelector('#sendCancellationEmail')?.checked !== false; // Default true
    
    if (!reason) {
        showToast('Please select a cancellation reason', 'warning');
        return;
    }
    
    showLoading(true);
    
    const requestData = {
        action: 'cancel',
        reason: reason,
        notes: notes,
        process_refund: processRefund,
        send_email: sendEmail
    };
    
    fetch(`/orders/admin/cancel/${orderId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(requestData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        showLoading(false);
        if (data.success) {
            showToast(data.message || 'Order cancelled and notification sent successfully!', 'success');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('cancelOrderModal'));
            modal.hide();
            
            // Update order row
            updateOrderRowStatus(orderId, 'cancelled');
            
            // Refresh counts
            refreshOrderCounts();
            
            // Reset form
            form.reset();
            
            console.log(`Order ${orderId} cancelled with email notification sent`);
        } else {
            showToast(data.message || 'Error cancelling order', 'error');
        }
    })
    .catch(error => {
        showLoading(false);
        console.error('Error cancelling order:', error);
        showToast('Network error occurred while cancelling order', 'error');
    });
}

function handleStatusUpdate() {
    const form = document.getElementById('updateStatusForm');
    const orderId = form.dataset.orderId;
    const status = form.querySelector('#statusSelect').value;
    const estimatedTime = form.querySelector('#estimatedReadyTime')?.value;
    const notes = form.querySelector('#statusNotes')?.value;
    const notifyCustomer = form.querySelector('#notifyCustomer')?.checked !== false; // Default true
    
    if (!status) {
        showToast('Please select a status', 'warning');
        return;
    }
    
    showLoading(true);
    
    const requestData = {
        action: 'update_status',
        status: status,
        estimated_ready_time: estimatedTime,
        notes: notes,
        notify_customer: notifyCustomer
    };
    
    fetch(`/orders/admin/update-status/${orderId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(requestData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        showLoading(false);
        if (data.success) {
            showToast(data.message || 'Order status updated successfully!', 'success');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('updateStatusModal'));
            modal.hide();
            
            // Update order row
            updateOrderRowStatus(orderId, status, data.order_data);
            
            // Refresh counts
            refreshOrderCounts();
            
            // Reset form
            form.reset();
            
            console.log(`Order ${orderId} status updated to ${status}`);
        } else {
            showToast(data.message || 'Error updating order status', 'error');
        }
    })
    .catch(error => {
        showLoading(false);
        console.error('Error updating order status:', error);
        showToast('Network error occurred while updating order status', 'error');
    });
}

function loadOrderDetails(orderId) {
    showLoading(true);
    
    fetch(`/orders/${orderId}/detail/`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        showLoading(false);
        if (data.success || data.order_number) {
            document.getElementById('orderDetailsContent').innerHTML = buildOrderDetailsHTML(data);
        } else {
            showToast('Error loading order details', 'error');
        }
    })
    .catch(error => {
        showLoading(false);
        console.error('Error loading order details:', error);
        
        // Fallback: try to extract details from the table row
        const orderRow = document.querySelector(`tr[data-order-id="${orderId}"]`);
        if (orderRow) {
            const fallbackDetails = extractOrderDetailsFromRow(orderRow);
            document.getElementById('orderDetailsContent').innerHTML = fallbackDetails;
        } else {
            showToast('Error loading order details', 'error');
        }
    });
}

function buildOrderDetailsHTML(orderData) {
    const items = orderData.items || [];
    return `
        <div class="order-details">
            <div class="row mb-3">
                <div class="col-md-6">
                    <h6>Order Information</h6>
                    <p><strong>Order #:</strong> ${orderData.order_number}</p>
                    <p><strong>Status:</strong> <span class="badge bg-info">${orderData.status}</span></p>
                    <p><strong>Total:</strong> ${orderData.total || orderData.total_amount} XAF</p>
                    <p><strong>Placed:</strong> ${orderData.created_at || 'N/A'}</p>
                </div>
                <div class="col-md-6">
                    <h6>Customer Information</h6>
                    <p><strong>Name:</strong> ${orderData.customer_name || 'N/A'}</p>
                    <p><strong>Email:</strong> ${orderData.customer_email || 'N/A'}</p>
                    <p><strong>Phone:</strong> ${orderData.customer_phone || 'N/A'}</p>
                    <p><strong>Office:</strong> ${orderData.office_number || 'N/A'}</p>
                </div>
            </div>
            <div class="mb-3">
                <h6>Order Items</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Quantity</th>
                                <th>Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${items.map(item => `
                                <tr>
                                    <td>${item.name}</td>
                                    <td>${item.quantity}</td>
                                    <td>${item.unit_price} XAF</td>
                                    <td>${item.total} XAF</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
            ${orderData.special_instructions ? `
                <div class="mb-3">
                    <h6>Special Instructions</h6>
                    <p class="text-muted">${orderData.special_instructions}</p>
                </div>
            ` : ''}
        </div>
    `;
}

function extractOrderDetailsFromRow(orderRow) {
    const orderNumber = orderRow.querySelector('td:first-child strong').textContent;
    const customerInfo = orderRow.querySelector('td:nth-child(2)').textContent.trim();
    const itemsInfo = orderRow.querySelector('td:nth-child(3)').innerHTML;
    const amount = orderRow.querySelector('td:nth-child(4)').textContent.trim();
    const status = orderRow.querySelector('td:nth-child(6) .badge').textContent.trim();
    const dateInfo = orderRow.querySelector('td:nth-child(7)').textContent.trim();
    
    return `
        <div class="order-details-fallback">
            <div class="row mb-3">
                <div class="col-md-6">
                    <h6>Order Information</h6>
                    <p><strong>Order #:</strong> ${orderNumber}</p>
                    <p><strong>Status:</strong> <span class="badge bg-info">${status}</span></p>
                    <p><strong>Total:</strong> ${amount}</p>
                    <p><strong>Date:</strong> ${dateInfo}</p>
                </div>
                <div class="col-md-6">
                    <h6>Customer Information</h6>
                    <p>${customerInfo}</p>
                </div>
            </div>
            <div class="mb-3">
                <h6>Order Items</h6>
                <div>${itemsInfo}</div>
            </div>
        </div>
    `;
}

function initializeFilters() {
    // Status Filter
    const statusFilter = document.getElementById('statusFilter');
    if (statusFilter) {
        statusFilter.addEventListener('change', function() {
            applyFilters();
        });
    }
    
    // Payment Filter
    const paymentFilter = document.getElementById('paymentFilter');
    if (paymentFilter) {
        paymentFilter.addEventListener('change', function() {
            applyFilters();
        });
    }
    
    // Time Filter
    const timeFilter = document.getElementById('timeFilter');
    if (timeFilter) {
        timeFilter.addEventListener('change', function() {
            applyFilters();
        });
    }
    
    // Customer Search
    const customerSearch = document.getElementById('customerSearch');
    if (customerSearch) {
        let searchTimeout;
        customerSearch.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                applyFilters();
            }, 500);
        });
    }
    
    // Order ID Search
    const orderIdSearch = document.getElementById('orderIdSearch');
    if (orderIdSearch) {
        let searchTimeout;
        orderIdSearch.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                applyFilters();
            }, 500);
        });
    }
    
    // Global Search
    const globalSearch = document.getElementById('globalSearch');
    if (globalSearch) {
        let searchTimeout;
        globalSearch.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                applyGlobalSearch(this.value);
            }, 300);
        });
    }
    
    // Sort Orders
    const sortOrders = document.getElementById('sortOrders');
    if (sortOrders) {
        sortOrders.addEventListener('change', function() {
            applySorting(this.value);
        });
    }
    
    // Date Range Filters
    const fromDate = document.getElementById('fromDate');
    const toDate = document.getElementById('toDate');
    if (fromDate) {
        fromDate.addEventListener('change', applyFilters);
    }
    if (toDate) {
        toDate.addEventListener('change', applyFilters);
    }
    
    // Clear Filters Button
    const clearFiltersBtn = document.getElementById('clearFiltersBtn');
    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', clearFilters);
    }
}

function applyFilters() {
    const statusFilter = document.getElementById('statusFilter')?.value || '';
    const paymentFilter = document.getElementById('paymentFilter')?.value || '';
    const timeFilter = document.getElementById('timeFilter')?.value || '';
    const customerSearch = document.getElementById('customerSearch')?.value.toLowerCase() || '';
    const orderIdSearch = document.getElementById('orderIdSearch')?.value.toLowerCase() || '';
    const fromDate = document.getElementById('fromDate')?.value || '';
    const toDate = document.getElementById('toDate')?.value || '';
    
    const tableRows = document.querySelectorAll('tbody tr');
    let visibleCount = 0;
    
    tableRows.forEach(row => {
        if (row.querySelector('td[colspan]')) return; // Skip "no orders found" row
        
        let showRow = true;
        
        // Status filter
        if (statusFilter && showRow) {
            const statusBadge = row.querySelector('td:nth-child(6) .badge');
            if (!statusBadge || !statusBadge.textContent.toLowerCase().includes(statusFilter.toLowerCase())) {
                showRow = false;
            }
        }
        
        // Payment filter
        if (paymentFilter && showRow) {
            const paymentBadge = row.querySelector('td:nth-child(5) .badge');
            if (paymentFilter === 'paid' && (!paymentBadge || !paymentBadge.textContent.toLowerCase().includes('paid'))) {
                showRow = false;
            } else if (paymentFilter === 'pending' && (!paymentBadge || !paymentBadge.textContent.toLowerCase().includes('pending'))) {
                showRow = false;
            } else if (paymentFilter === 'failed' && (!paymentBadge || !paymentBadge.textContent.toLowerCase().includes('failed'))) {
                showRow = false;
            }
        }
        
        // Customer search
        if (customerSearch && showRow) {
            const customerCell = row.querySelector('td:nth-child(2)');
            if (!customerCell || !customerCell.textContent.toLowerCase().includes(customerSearch)) {
                showRow = false;
            }
        }
        
        // Order ID search
        if (orderIdSearch && showRow) {
            const orderIdCell = row.querySelector('td:first-child');
            if (!orderIdCell || !orderIdCell.textContent.toLowerCase().includes(orderIdSearch)) {
                showRow = false;
            }
        }
        
        // Date range filter
        if ((fromDate || toDate) && showRow) {
            const dateCell = row.querySelector('td:nth-child(7)');
            if (dateCell) {
                const orderDate = new Date(dateCell.textContent.trim());
                if (fromDate && orderDate < new Date(fromDate)) {
                    showRow = false;
                }
                if (toDate && orderDate > new Date(toDate + 'T23:59:59')) {
                    showRow = false;
                }
            }
        }
        
        row.style.display = showRow ? '' : 'none';
        if (showRow) visibleCount++;
    });
    
    // Update visible count indicator
    updateFilterResultsCount(visibleCount);
}

function applyGlobalSearch(searchTerm) {
    const tableRows = document.querySelectorAll('tbody tr');
    let visibleCount = 0;
    
    tableRows.forEach(row => {
        if (row.querySelector('td[colspan]')) return; // Skip "no orders found" row
        
        const rowText = row.textContent.toLowerCase();
        const showRow = !searchTerm || rowText.includes(searchTerm.toLowerCase());
        
        row.style.display = showRow ? '' : 'none';
        if (showRow) visibleCount++;
    });
    
    updateFilterResultsCount(visibleCount);
}

function applySorting(sortBy) {
    const tbody = document.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr')).filter(row => !row.querySelector('td[colspan]'));
    
    rows.sort((a, b) => {
        switch (sortBy) {
            case 'newest':
            case 'Newest First':
                return compareDates(
                    extractDateFromRow(b),
                    extractDateFromRow(a)
                );
            case 'oldest':
            case 'Oldest First':
                return compareDates(
                    extractDateFromRow(a),
                    extractDateFromRow(b)
                );
            case 'amount_high':
            case 'Amount (High to Low)':
                return extractAmount(b) - extractAmount(a);
            case 'amount_low':
            case 'Amount (Low to High)':
                return extractAmount(a) - extractAmount(b);
            case 'status':
            case 'By Status':
                return extractStatus(a).localeCompare(extractStatus(b));
            default:
                return 0;
        }
    });
    
    // Reorder rows in DOM
    rows.forEach(row => tbody.appendChild(row));
}

// Helper functions for sorting
function extractDateFromRow(row) {
    const dateCell = row.querySelector('td:nth-child(7)');
    return dateCell ? new Date(dateCell.textContent.trim()) : new Date(0);
}

function extractAmount(row) {
    const amountCell = row.querySelector('td:nth-child(4)');
    const amountText = amountCell ? amountCell.textContent.replace(/[^\d.]/g, '') : '0';
    return parseFloat(amountText) || 0;
}

function extractStatus(row) {
    const statusBadge = row.querySelector('td:nth-child(6) .badge');
    return statusBadge ? statusBadge.textContent.trim() : '';
}

function extractEmailFromRow(row) {
    const customerCell = row.querySelector('td:nth-child(2)');
    if (customerCell) {
        const emailMatch = customerCell.textContent.match(/[\w\.-]+@[\w\.-]+\.\w+/);
        return emailMatch ? emailMatch[0] : '';
    }
    return '';
}

function compareDates(date1, date2) {
    return date1.getTime() - date2.getTime();
}

function updateFilterResultsCount(count) {
    let indicator = document.getElementById('filter-results-indicator');
    if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'filter-results-indicator';
        indicator.className = 'text-muted small mb-2';
        const tableContainer = document.querySelector('.table-responsive');
        if (tableContainer) {
            tableContainer.parentNode.insertBefore(indicator, tableContainer);
        }
    }
    indicator.textContent = `Showing ${count} order${count !== 1 ? 's' : ''}`;
}

function clearFilters() {
    // Clear all filter inputs
    const filterInputs = ['statusFilter', 'paymentFilter', 'timeFilter', 'customerSearch', 'orderIdSearch', 'globalSearch', 'fromDate', 'toDate'];
    filterInputs.forEach(filterId => {
        const element = document.getElementById(filterId);
        if (element) {
            element.value = '';
        }
    });
    
    // Show all rows
    const tableRows = document.querySelectorAll('tbody tr');
    tableRows.forEach(row => {
        row.style.display = '';
    });
    
    // Remove results indicator
    const indicator = document.getElementById('filter-results-indicator');
    if (indicator) {
        indicator.remove();
    }
    
    showToast('All filters cleared', 'info');
}

function updateOrderRowStatus(orderId, newStatus, orderData = null) {
    const row = document.querySelector(`tr[data-order-id="${orderId}"]`);
    if (!row) return;
    
    // Update status badge
    const statusCell = row.querySelector('td:nth-child(6)');
    const statusBadge = statusCell.querySelector('.badge');
    
    if (statusBadge) {
        // Remove existing status classes
        statusBadge.classList.remove('bg-warning', 'bg-info', 'bg-primary', 'bg-success', 'bg-danger', 'bg-secondary');
        
        // Add new status class and text
        const statusConfig = {
            'pending': { class: 'bg-warning', text: 'Pending' },
            'confirmed': { class: 'bg-info', text: 'Confirmed' },
            'preparing': { class: 'bg-primary', text: 'Preparing' },
            'ready': { class: 'bg-success', text: 'Ready' },
            'completed': { class: 'bg-success', text: 'Completed' },
            'cancelled': { class: 'bg-danger', text: 'Cancelled' }
        };
        
        const config = statusConfig[newStatus.toLowerCase()] || statusConfig['pending'];
        statusBadge.classList.add(config.class);
        statusBadge.textContent = config.text;
        
        // Update ETA if provided
        if (orderData && orderData.estimated_ready_time) {
            let etaElement = statusCell.querySelector('.eta-time');
            if (!etaElement) {
                etaElement = document.createElement('br');
                statusCell.appendChild(etaElement);
                etaElement = document.createElement('small');
                etaElement.className = 'eta-time text-muted d-block';
                statusCell.appendChild(etaElement);
            }
            etaElement.textContent = `ETA: ${orderData.estimated_ready_time}`;
        }
    }
    
    // Update action buttons based on new status
    updateActionButtons(row, newStatus);
}

function updateActionButtons(row, status) {
    const actionCell = row.querySelector('td:last-child');
    if (!actionCell) return;
    
    const orderId = row.dataset.orderId;
    let buttonsHTML = '';
    
    // Build buttons based on status
    switch (status.toLowerCase()) {
        case 'pending':
            buttonsHTML = `
                <button class="btn btn-sm btn-success confirm-order-btn me-1" data-order-id="${orderId}" title="Confirm Order">
                    <i class="bi bi-check"></i>
                </button>
                <button class="btn btn-sm btn-info me-1" data-bs-toggle="modal" data-bs-target="#orderDetailsModal" data-order-id="${orderId}" title="View Details">
                    <i class="bi bi-eye"></i>
                </button>
                <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#cancelOrderModal" data-order-id="${orderId}" title="Cancel Order">
                    <i class="bi bi-x"></i>
                </button>
            `;
            break;
            
        case 'confirmed':
        case 'preparing':
        case 'ready':
            buttonsHTML = `
                <button class="btn btn-sm btn-primary me-1" data-bs-toggle="modal" data-bs-target="#updateStatusModal" data-order-id="${orderId}" title="Update Status">
                    <i class="bi bi-arrow-up-circle"></i>
                     <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#updateStatusModal" data-order-id="${orderId}" title="Update Status">
                    <i class="bi bi-x"></i>
                </button>
            `;
    }}
</script>
{% endblock %};