<!-- Update proceed_to_payment.html similar to above -->
{% extends "base/base.html" %}

{% block content %}
<div class="container mt-4">
  <div class="card">
    <div class="card-header">
      <h5>Proceed to Payment</h5>
    </div>
    <div class="card-body">
      <p>Your order {{ order.order_number }} has been validated by the canteen admin.</p>
      <p>Total Amount: {{ order.total_amount }} FCFA</p>
      
      <form id="paymentForm">
        {% csrf_token %}
        <div class="mb-3">
          <label for="phone" class="form-label">Phone Number (for MoMo or Orange)</label>
          <input type="tel" class="form-control" id="phone" name="phone" required placeholder="+237xxxxxxxxx">
        </div>
        <button type="submit" class="btn btn-primary">Pay Now</button>
      </form>
      
      <p class="mt-3 text-muted">⚠️ Ask the administrator to enable the payment gateway.</p>
    </div>
  </div>
</div>

<script>
// Same JS as payment_checkout.html, adapted for this template
document.getElementById('paymentForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const formData = new FormData(this);
  formData.append('order_id', '{{ order.id }}');
  formData.append('amount', '{{ order.total_amount }}');
  fetch('{% url "payments:process_payment" %}', {
    method: 'POST',
    body: JSON.stringify(Object.fromEntries(formData))
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast('Payment initiated. Reference: ' + data.reference, 'success');
      // Poll status
      setInterval(() => {
        fetch(`{% url "payments:check_status" transaction_id=data.reference %}`)
          .then(res => res.json())
          .then(statusData => {
            if (statusData.status === 'SUCCESSFUL') {
              showToast('Payment completed', 'success');
            }
          });
      }, 5000);
    } else {
      showToast(data.error, 'danger');
    }
  })
  .catch(() => showToast('Error initiating payment', 'danger'));
});
</script>
{% endblock %}